by = "month") %>%
format("%m/%Y")
geoids  <- unique(evictions_df$GEOID)
# expand a grid of GEOID/month combinations
geoids_months <- expand.grid(GEOID = geoids,
month = months,
stringsAsFactors = F)
# identify missing combinations
missing <- geoids_months %>%
anti_join(evictions_df %>% select(GEOID, month),
by = c("GEOID", "month"))
# print result
if (nrow(missing) > 0){
cat("Number of Missing GEOID/Month Combinations:", nrow(missing))
} else{
cat("No GEOID/Month Combinations Missing")
}
# designate FIPS codes for PA and Philly
fips_pa <- 42
fips_phl <- 101
# load tigris census tract boundaries
tracts <- tracts(state = 42, county = 101, year = 2020, progress_bar = F) %>%
select(GEOID) %>%
st_transform(2272)
# join to evictions dataset and make spatial
evictions <- left_join(evictions_df, tracts, by = "GEOID", ) %>%
st_as_sf()
# manufacture month and year columns, convert existing month column to 'date'
# evictions <- evictions %>%
#   rename(date = month) %>%
#   mutate(
#     month = month(my(date)),
#     year = year(my(date)),
#     filings_2020_log = log(filings_2020 + 1)
#   )
# Create proper date format
evictions <- evictions %>%
mutate(
month_date = as.Date(paste0("01/", month), format = "%d/%m/%Y"),
delta = filings_2020 - filings_avg_prepandemic_baseline,
ratio = filings_2020 / filings_avg_prepandemic_baseline
)
# Total filings per tract
tract_totals <- evictions %>%
group_by(GEOID) %>%
summarise(total_filings = sum(filings_2020, na.rm = TRUE))
#Plot
ggplot(tract_totals) +
geom_sf(aes(fill = total_filings),
color = "white", linewidth = 0.2) +
scale_fill_viridis_c(option = "C") +
labs(
title = "Total Eviction Filings by Census Tract",
subtitle = "Cumulative filings across all years in the dataset",
fill = "Total Filings"
) +
theme_void()
# Top 10 Tracts - Eviction Filing Hotspots
tract_totals %>%
arrange(desc(total_filings)) %>%
slice_head(n = 10)
# Bottom 10 Tracts
tract_totals %>%
arrange(total_filings) %>%
slice_head(n = 10)
# Create monthly evictions
eviction_monthly <- evictions %>%
group_by(month_date) %>%
summarise(total_filings = sum(filings_2020, na.rm = TRUE))
# Plot total monthly evictions
ggplot(eviction_monthly, aes(x = month_date, y = total_filings)) +
geom_line(color = "#3182bd", linewidth = 1) +             # blue line
geom_smooth(se = FALSE, color = "red", linetype = "dashed") +  # red trend line
labs(
title = "Monthly Eviction Filings",
subtitle = "Tract-level eviction filings aggregated across the city",
x = "Date",
y = "Total Filings",
caption = "Source: Eviction Court Filings"
)
evictions %>%
group_by(month_date, racial_majority) %>%
summarise(total_filings = sum(filings_2020, na.rm = TRUE), .groups = "drop") %>%
ggplot(aes(month_date, total_filings, color = racial_majority)) +
geom_line() +
labs(title = "Eviction Filings Over Time by Racial-Majority Tract",
x = "Date", y = "Total Filings",
color = "Racial Majority") +
theme_minimal()
# Create monthly evictions
# Filings_2020 = total eviction filings
ggplot(evictions %>% filter(filings_2020 <= 50),
aes(filings_2020)) +
geom_histogram(bins = 30, fill = "steelblue") +
labs(title = "Distribution of Monthly Filings per Tract (<= 50)",
x = "Filings", y = "Count")
# Distribution of Delta
ggplot(evictions, aes(delta)) +
geom_histogram(bins = 30, fill = "purple") +
labs(
title = "Delta: Filings vs Pre-Pandemic Baseline",
x = "Delta",
y = "Count"
)
# Distribution of Ratio
ggplot(evictions, aes(ratio)) +
geom_histogram(bins = 30, fill = "darkgreen") +
labs(
title = "Ratio of Filings to Baseline",
x = "Ratio",
y = "Count"
)
evictions %>%
group_by(racial_majority) %>%
summarise(mean_filings = mean(filings_2020, na.rm = TRUE)) %>%
ggplot(aes(racial_majority, mean_filings, fill = racial_majority)) +
geom_col() +
labs(
title = "Average Monthly Eviction Filings by Racial-Majority Tract",
x = "Racial Majority Group",
y = "Average Monthly Filings"
) +
theme_minimal() +
theme(legend.position = "none")
housing_sf <- st_read('./data/Affordable_Housing.geojson', quiet = T) %>%
st_transform(2272)
# filter out properties for which there is no year associated and geometry is not empty
housing <- housing_sf %>%
filter(!is.na(fiscal_year_complete),
!st_is_empty(.)) %>%
st_join(tracts, join = st_within)
ggplot() +
geom_sf(data = tracts,
fill = NA,
color = 'grey70') +
geom_sf(data = housing,
mapping = aes(size = total_units),
lwd = 0,
color = 'purple4',
alpha = 0.25) +
labs(title = "Affordable Housing in Philadelphia",
subtitle = "Locations and Total Unit Counts",
size = 'Total Units') +
theme_void()
housing_cnts <- housing %>%
st_drop_geometry() %>%
group_by(GEOID, fiscal_year_complete) %>%
summarise(n_proj = n(),
total_units = sum(total_units)) %>%
mutate(n_proj_cum = ave(n_proj, FUN = cumsum),
total_units_cum = ave(total_units, FUN = cumsum)) %>%
filter(fiscal_year_complete >= 2020) %>%
left_join(tracts, by = "GEOID") %>%
st_as_sf(crs = 2272)
ggplot() +
geom_sf(data = tracts, color = 'grey85', fill = NA) +
geom_sf(data = housing_cnts, aes(fill = total_units_cum)) +
facet_wrap(~fiscal_year_complete) +
theme_void()
# read in crime data
crime <- read_csv('./data/incidents_part1_part2.csv', show_col_types = F)
# filter out any entries that don't have a location
crime <- crime %>% filter(!if_all(c('point_x', 'point_y', 'lat', 'lng'), is.na))
View(housing_cnts)
View(crime)
crimes %>% unique(text_general_code)
crime %>% unique(text_general_code)
crime %>% unique(text_general_code)
unique(crime$text_general_code)
crime <- crime_df %>% st_as_sf()
# read in crime data
crime_df <- read_csv('./data/incidents_part1_part2.csv', show_col_types = F)
# filter out any entries that don't have a location
crime_df <- crime_df %>% filter(!if_all(c('point_x', 'point_y', 'lat', 'lng'), is.na))
crime <- crime_df %>% st_as_sf()
crime <- crime_df %>% st_as_sf(coords = c('lat', 'lng'), crs=4326)
crime <- crime_df %>% st_as_sf(coords = c(lat, lng), crs=4326)
crime <- crime_df %>% st_as_sf(coords = c('lat', 'lng'), crs=4326)
crime <- crime_df %>% st_as_sf(coords=c('lat', 'lng'), crs=4326)
?st_as_sf
View(crime_df)
# filter out any entries that don't have a location
crime_df <- crime_df %>% filter(!if_any(c('point_x', 'point_y', 'lat', 'lng'), is.na))
crime <- crime_df %>% st_as_sf(coords=c('lat', 'lng'), crs=4326)
plot(crime %>% sample(size = 100))
plot(sample(crime, size = 100))
sample(crime, size = 100)
sample(0:100, size = 100)
sample(0:1000, size = 100)
sample(crime_df, size = 100)
sample_n(crime_df, size = 100)
set.seed(5746)
sample_n(crime_df, size = 100)
sample_n(crime_df, size = 100) %>% plot()
plot(sample_n(crime_df, size = 100)[,'geometry'])
plot(sample_n(crime_df, size = 100))
test <- sample_n(crime_df, size = 100)
plot(sample_n(crime, size = 100)[,'geometry'])
crime <- crime_df %>% st_as_sf(coords=c('lng', 'lat'), crs=4326)
plot(sample_n(crime, size = 100)[,'geometry'])
crime <- crime_df %>% st_as_sf(coords=c('lng', 'lat'), crs=4326)
# read in crime data
crime_df <- read_csv('./data/incidents_part1_part2.csv', show_col_types = F)
# filter out any entries that don't have a location
crime_df <- crime_df %>% filter(!if_any(c('point_x', 'point_y', 'lat', 'lng'), is.na))
crime <- crime_df %>% st_as_sf(coords=c('lng', 'lat'), crs=4326)
# join tract geoid to crimes
crime_tract <- st_join(crime, tracts, join = st_intersects)
st_crs(tracts)
crime <- crime_df %>% st_as_sf(coords=c('lng', 'lat'), crs=4326) %>%
st_transform(st_crs(tracts))
# join tract geoid to crimes
crime_tract <- st_join(crime, tracts, join = st_intersects)
crime <- crime_df %>% st_as_sf(coords=c('lng', 'lat'), crs=4326) %>%
st_transform(2272)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n())
View(crime_cnts)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n())
View(crime_cnts)
table(crime_cnts$GEOID)
# join tract geoid to crimes
crime_tract <- st_join(crime, tracts, join = st_intersects)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
complete(GEOID, text_general_code, fill = list(count = 0))
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n())
test <- crime_cnts
View(crime_cnts)
complete(GEOID, text_general_code, fill = list(count = 0))
test <- crime_cnts %>%
complete(GEOID, text_general_code, fill = list(count = 0))
complete('GEOID', text_general_code, fill = list(count = 0))
test <- crime_cnts %>%
complete(GEOID, text_general_code)
test <- crime_cnts %>%
complete(data = ., GEOID, text_general_code)
test <- crime_cnts %>%
complete(data = ., GEOID, text_general_code)
test <- crime_cnts %>%
complete(data = ., GEOID, text_general_code)
test <- complete(data = crime_cnts, GEOID, text_general_code)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup()
test <- complete(data = crime_cnts, GEOID, text_general_code)
length(unique(crime_cnts$text_general_code))
31*408
length(unique(crime_cnts$GEOID))
unique(crime_cnts$GEOID) %in% tracts$GEOID
crime_cnts %>% filter(unique(crime_cnts$GEOID) %in% tracts$GEOID)
crime_cnts %>% subset(crime_cnts$GEOID) %in% tracts$GEOID)
crime_cnts %>% subset(crime_cnts$GEOID) %in% tracts$GEOID))
crime_cnts %>% subset(crime_cnts$GEOID %in% tracts$GEOID)
crime_cnts %>% subset(!(crime_cnts$GEOID %in% tracts$GEOID))
# join tract geoid to crimes
crime_tract <- st_join(crime, tracts, join = st_intersects) %>%
filter(!is.na(GEOID))
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup() %>%
complete(data = crime_cnts, GEOID, text_general_code, fill = list(count = 0))
# join tract geoid to crimes and filter out those not in Philly
crime_tract <- st_join(crime, tracts, join = st_intersects) %>%
filter(!is.na(GEOID))
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup() %>%
complete(data = crime_cnts, GEOID, text_general_code)
test <- crime_cnts %>%
complete(data = crime_cnts, GEOID, text_general_code)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup() %>%
complete(data = ., GEOID, text_general_code)
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup() %>%
complete(data = ., GEOID, text_general_code, fill = list(count = 0))
unique(crime_cnts$text_general_code)
unique(crime_cnts$text_general_code) %>% length()
unique(crime_cnts$GEOID) %>% length()
408*31
mva <- st_read('./data/mva_2023.geojson', quiet = T)
View(mva)
plot(mva[,"Shape__Area"])
unique(mva$geoid)
unique(mva$geoid) %>% length
tracts$GEOID
test <- mva %>% subset(geoid %in% tracts$GEOID)
unique(mva$geoid)  %in% tracts$GEOID
View(tracts)
View(mva)
nchar('421010001011')
plot(mva$geometry)
plot(tracts$geometry)
# read in results of
mva <- st_read('./data/mva_2023.geojson', quiet = T) %>%
st_transform(2272)
plot(mva$geometry)
plot(tracts$geometry)
mutate(GEOID_Tract = substr(geoid, 1, nchar(geoid)-1)
# the data is at the block group level
# GEOID (12 digits) = tract (11 digits) + block grp (1 digit)
mva <- mva %>%
# the data is at the block group level
# GEOID (12 digits) = tract (11 digits) + block grp (1 digit)
mva <- mva %>%
mutate(GEOID_Tract = substr(geoid, 1, nchar(geoid)-1))
unique(mva$GEOID_Tract)
unique(mva$GEOID_Tract) %>% length()
is.na(mva$GEOID_Tract)
is.na(mva$GEOID_Tract) sum()
is.na(mva$GEOID_Tract) %>% sum()
mva$GEOID_Tract %in% tracts$GEOID
sum(mva$GEOID_Tract %in% tracts$GEOID)
sum(unique(mva$GEOID_Tract) %in% tracts$GEOID)
unique(mva$GEOID_Tract) %in% tracts$GEOID
test <- unique(mva$GEOID_Tract) %>% subset(unique(mva$GEOID_Tract) %in% tracts$GEOID)
test <- unique(mva$GEOID_Tract) %>% subset(!(unique(mva$GEOID_Tract) %in% tracts$GEOID))
test <- unique(tracts$GEOID) %>% subset(!(unique(mva$GEOID_Tract) %in% tracts$GEOID))
test <- unique(tracts$GEOID) %>% subset(!(tracts$GEOID %in% unique(mva$GEOID_Tract)))
tracts$test <- ifelse(tracts$GEOID == test, 1, 0)
plot(tracts[,"test"])
hca <- st_read('./data/HousingCounselingAgencies.geojson', quiet = T) %>%
st_transform(2272)
View(hca)
tracts_cent <- tracts %>%
st_centroid()
View(tracts_cent)
tracts %>% select(-test)
hca_dist <- tracts %>%
st_d
tracts <- tracts %>% select(-test)
tracts_cent <- tracts %>%
st_centroid()
hca_dist <- tracts %>%
st_distance(tracts, hca)
408*28
test <- st_distance(tracts, hca)
# create k-nearest neighbors function
get_knn_distance <- function(dist_matrix, k) {
apply(dist_matrix, 1, function(distances) {
mean(as.numeric(sort(distances)[1:k]))
})
}
hca_distmatrix <- st_distance(tracts, hca)
hca_distmatrix <- st_distance(tracts_cent, hca)
hca_dist <- tracts %>%
mutate(dist_1hca = get_knn_distance(hca_distmatrix, k = 1),
dist_3hca = get_knn_distance(hca_distmatrix, k = 3))
View(hca_dist)
```{r message=FALSE}
housing_cnts <- housing %>%
st_drop_geometry() %>%
group_by(GEOID, fiscal_year_complete) %>%
summarise(n_proj = n(),
total_units = sum(total_units)) %>%
mutate(n_proj_cum = ave(n_proj, FUN = cumsum),
total_units_cum = ave(total_units, FUN = cumsum)) %>%
filter(fiscal_year_complete >= 2020) %>%
left_join(tracts, by = "GEOID") %>%
st_as_sf(crs = 2272)
# join tract geoid to crimes and filter out those not in Philly
crime_tract <- st_join(crime, tracts, join = st_intersects) %>%
filter(!is.na(GEOID))
# summarize by the number of each type of crime per census tract
crime_cnts <- crime_tract %>%
st_drop_geometry() %>%
group_by(GEOID, text_general_code) %>%
summarise(count = n()) %>%
ungroup() %>%
complete(data = ., GEOID, text_general_code, fill = list(count = 0))
years <- seq(2020:2023)
years <- c(2020:2023)
years <- c(2018:2023)
years <- c(2020:2023)
fips_pa <- 42
acs_vars <- load_variables(year = 2023, dataset = 'acs5')
View(acs_vars)
vars <- c('pop_tot' = 'B01003_001',   # total tract population
'pop_white' = 'B02001_002', # white population (for %-non-white calc)
'units_tot' = 'B25001_001', # total housing units
'hh_tot' = 'B11001_001',    # total households
'hh_fam' = 'B11001_002')    # family households)
demo_vars <- map_df(years, function(y) {
get_acs(
geography = "state",
variables = vars,
year = y,
survey = "acs5",
progress_bar = F
) %>%
mutate(year = y)
})
View(demo_vars)
408*6
408*3
get_acs(
geography = "state",
variables = vars,
year = y,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
) %>%
mutate(year = y)
demo_vars <- map_df(years, function(y) {
get_acs(
geography = "state",
variables = vars,
year = y,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
) %>%
mutate(year = y)
})
View(demo_vars)
# designate FIPS codes for PA and Philly
fips_pa <- 42
fips_phl <- 101
# load tigris census tract boundaries
tracts <- tracts(state = 42, county = 101, year = 2020, progress_bar = F) %>%
select(GEOID) %>%
st_transform(2272)
# join to evictions dataset and make spatial
evictions <- left_join(evictions_df, tracts, by = "GEOID", ) %>%
st_as_sf()
demo_vars <- map_df(years, function(y) {
get_acs(
geography = "state",
variables = vars,
year = y,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
) %>%
mutate(year = y)
})
get_acs(
geography = "state",
variables = vars,
year = 2020,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
)
get_acs(
geography = "tract",
variables = vars,
year = 2020,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
)
years <- c(2020:2023)
acs_vars <- load_variables(year = 2023, dataset = 'acs5')
years <- c(2020:2023)
vars <- c('pop_tot' = 'B01003_001',   # total tract population
'pop_white' = 'B02001_002', # white population (for %-non-white calc)
'units_tot' = 'B25001_001', # total housing units
'hh_tot' = 'B11001_001',    # total households
'hh_fam' = 'B11001_002')    # family households)
demo_vars <- map_df(years, function(y) {
get_acs(
geography = "tract",
variables = vars,
year = y,
survey = "acs5",
state = fips_pa,
county = fips_phl,
progress_bar = F
) %>%
mutate(year = y)
})
408*4
View(demo_vars)
408*4*5
