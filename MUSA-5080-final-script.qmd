---
title: "Space-Time Prediction of Bike Share Demand: Philadelphia Indego"
author: "Nina Carlson, Ryan Drake, Chloe Robinson, Henry Sywulak-Herr"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    code_download: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r load-packages}
if(!require(pacman)){install.packages("pacman"); library(pacman, quietly = T)}
p_load(lubridate,tidycensus, tidyverse, tigris, sf)
```

```{r load-data}
# load evictions dataset to investigate
evictions_df <- read_csv("./data/philadelphia_monthly_2020_2021.csv", show_col_types = F)

evictions_df <- evictions_df %>%
  filter(GEOID != "sealed")
```

```{r load-census-tracts}
# designate FIPS codes for PA and Philly
fips_pa <- 42
fips_phl <- 101

# load tigris census tract boundaries
tracts <- tracts(state = 42, county = 101, year = 2023, progress_bar = F) %>% 
  select(GEOID)

# join 
evictions <- left_join(evictions_df, tracts, by = "GEOID", ) %>% 
  st_as_sf()
```

# Exploratory Data Analysis 


```{r summarize-evictions-data}
ggplot() +
    geom_sf(data = evictions, aes(fill = filings_avg),
          color = "white", linewidth = 0.1) +
  scale_fill_viridis_b(
  limits = range(evictions$filings_avg, na.rm = TRUE),
  na.value = "lightgray"
) +
  theme_void()
```
```{r create-date-format}
# Create proper date format
evictions <- evictions %>%
  mutate(
    month_date = as.Date(paste0("01/", month), format = "%d/%m/%Y"),
    delta = filings_2020 - filings_avg_prepandemic_baseline,
    ratio = filings_2020 / filings_avg_prepandemic_baseline
  )
```

## Total Filings Per Tract

```{r create-total_filings}
# Total filings per tract
tract_totals <- evictions %>%
  group_by(GEOID) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE))

#Plot
ggplot(tract_totals) +
  geom_sf(aes(fill = total_filings), 
          color = "white", linewidth = 0.2) +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Total Eviction Filings by Census Tract",
    subtitle = "Cumulative filings across all years in the dataset",
    fill = "Total Filings"
  ) +
  theme_void()
```

## Hotspots

```{r top-tracts}
# Top 10 Tracts - Eviction Filing Hotspots
tract_totals %>%
  arrange(desc(total_filings)) %>%
  slice_head(n = 10)

# Bottom 10 Tracts
tract_totals %>%
  arrange(total_filings) %>%
  slice_head(n = 10)
```

## Temporal Trends

### Total Monthly Filings

```{r create-monthly-evictions-plot}
# Create monthly evictions
eviction_monthly <- evictions %>%
  group_by(month_date) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE))

# Plot total monthly evictions 
ggplot(eviction_monthly, aes(x = month_date, y = total_filings)) +
  geom_line(color = "#3182bd", linewidth = 1) +             # blue line
  geom_smooth(se = FALSE, color = "red", linetype = "dashed") +  # red trend line
  labs(
    title = "Monthly Eviction Filings",
    subtitle = "Tract-level eviction filings aggregated across the city",
    x = "Date",
    y = "Total Filings",
    caption = "Source: Eviction Court Filings"
  )
```
### Filings Over Time by Racial Majority

```{r evictions-by-race}
evictions %>%
  group_by(month_date, racial_majority) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(month_date, total_filings, color = racial_majority)) +
  geom_line() +
  labs(title = "Eviction Filings Over Time by Racial-Majority Tract",
       x = "Date", y = "Total Filings",
       color = "Racial Majority") +
  theme_minimal()
```

## Discriptive Distributions 

### Distribution of Monthly Findings

```{r create-monthly-predictions-plot-by-tract}
# Create monthly evictions
# Filings_2020 = total eviction filings
ggplot(evictions %>% filter(filings_2020 <= 50),
       aes(filings_2020)) +
  geom_histogram(bins = 30, fill = "steelblue") +
  labs(title = "Distribution of Monthly Filings per Tract (<= 50)",
       x = "Filings", y = "Count")
```

### Distribution of Delta

```{r change-from-baseline-distribution}
# Distribution of Delta 
ggplot(evictions, aes(delta)) +
  geom_histogram(bins = 30, fill = "purple") +
  labs(
    title = "Delta: Filings vs Pre-Pandemic Baseline",
    x = "Delta",
    y = "Count"
  )
```

### Distribution of Ratio

```{r change-from-baseline-distribution-ratio}
# Distribution of Ratio 
ggplot(evictions, aes(ratio)) +
  geom_histogram(bins = 30, fill = "darkgreen") +
  labs(
    title = "Ratio of Filings to Baseline",
    x = "Ratio",
    y = "Count"
  )
```

## Racial Disparaties 

```{r mean-filings-by-race}
evictions %>%
  group_by(racial_majority) %>%
  summarise(mean_filings = mean(filings_2020, na.rm = TRUE)) %>%
  ggplot(aes(racial_majority, mean_filings, fill = racial_majority)) +
  geom_col() +
  labs(
    title = "Average Monthly Eviction Filings by Racial-Majority Tract",
    x = "Racial Majority Group",
    y = "Average Monthly Filings"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

