---
title: "Space-Time Prediction of Bike Share Demand: Philadelphia Indego"
author: "Nina Carlson, Ryan Drake, Chloe Robinson, Henry Sywulak-Herr"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    code_download: true
editor_options: 
  markdown: 
    wrap: 72
---

# Load Packages

```{r load-packages, message=FALSE}
if(!require(pacman)){install.packages("pacman"); library(pacman, quietly = T)}
p_load(lubridate, sf, tidycensus, tidygeocoder, tidyverse, tigris, tmap, viridis)

set.seed(5746)
```

# Load Data

## Evictions Dataset

This dataset, derived from the Evictions Lab's Eviction Tracking System.
City-wide records that had missiong/incorrect GEOIDs are labeled as
"sealed." This leads to a slight-to-moderate underestimation of
evictions on average within the dataset.

```{r load-data}
# load evictions dataset to investigate
evictions_df <- read_csv("./data/philadelphia_monthly_2020_2021.csv", show_col_types = F)

evictions_df <- evictions_df %>%
  filter(GEOID != "sealed")

```

```{r missing-combos-check}
# generate vectors of all possible months and GEOIDs
months <- seq(as.Date("2020-01-01"),
              as.Date("2025-11-01"),
              by = "month") %>% 
  format("%m/%Y")
geoids  <- unique(evictions_df$GEOID)

# expand a grid of GEOID/month combinations
geoids_months <- expand.grid(GEOID = geoids,
                             month = months,
                             stringsAsFactors = F)

# identify missing combinations
missing <- geoids_months %>% 
  anti_join(evictions_df %>% select(GEOID, month),
            by = c("GEOID", "month"))

# print result
if (nrow(missing) > 0){
  cat("Number of Missing GEOID/Month Combinations:", nrow(missing))
} else{
  cat("No GEOID/Month Combinations Missing")
}
```

## Census Tracts

```{r load-census-tracts}
# designate FIPS codes for PA and Philly
fips_pa <- 42
fips_phl <- 101

# load tigris census tract boundaries
tracts <- tracts(state = 42, county = 101, year = 2020, progress_bar = F) %>% 
  select(GEOID) %>% 
  st_transform(2272)

# join to evictions dataset and make spatial
evictions <- left_join(evictions_df, tracts, by = "GEOID", ) %>% 
  st_as_sf() %>% 
  mutate(month_lag_census = year(my(month)) - 2)
```

```{r month-year-cols}
# manufacture month and year columns, convert existing month column to 'date'
# evictions <- evictions %>% 
#   rename(date = month) %>% 
#   mutate(
#     month = month(my(date)),
#     year = year(my(date)),
#     filings_2020_log = log(filings_2020 + 1)
#   )
```

# Exploratory Data Analysis - Evictions

```{r create-date-format}
# Create proper date format
evictions <- evictions %>%
  mutate(
    month_date = as.Date(paste0("01/", month), format = "%d/%m/%Y"),
    delta = filings_2020 - filings_avg_prepandemic_baseline,
    ratio = filings_2020 / filings_avg_prepandemic_baseline
  )
```

## Total Filings Per Tract

```{r create-total_filings}
# Total filings per tract
tract_totals <- evictions %>%
  group_by(GEOID) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE))

#Plot
ggplot(tract_totals) +
  geom_sf(aes(fill = total_filings), 
          color = "white", linewidth = 0.2) +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Total Eviction Filings by Census Tract",
    subtitle = "Cumulative filings across all years in the dataset",
    fill = "Total Filings"
  ) +
  theme_void()
```

## Hotspots

```{r top-tracts}
# Top 10 Tracts - Eviction Filing Hotspots
tract_totals %>%
  arrange(desc(total_filings)) %>%
  slice_head(n = 10)

# Bottom 10 Tracts
tract_totals %>%
  arrange(total_filings) %>%
  slice_head(n = 10)
```

## Temporal Trends

### Total Monthly Filings

```{r create-monthly-evictions-plot}
# Create monthly evictions
eviction_monthly <- evictions %>%
  group_by(month_date) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE))

# Plot total monthly evictions 
ggplot(eviction_monthly, aes(x = month_date, y = total_filings)) +
  geom_line(color = "#3182bd", linewidth = 1) +             # blue line
  geom_smooth(se = FALSE, color = "red", linetype = "dashed") +  # red trend line
  labs(
    title = "Monthly Eviction Filings",
    subtitle = "Tract-level eviction filings aggregated across the city",
    x = "Date",
    y = "Total Filings",
    caption = "Source: Eviction Court Filings"
  )
```

### Filings Over Time by Racial Majority

```{r evictions-by-race}
evictions %>%
  group_by(month_date, racial_majority) %>%
  summarise(total_filings = sum(filings_2020, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(month_date, total_filings, color = racial_majority)) +
  geom_line() +
  labs(title = "Eviction Filings Over Time by Racial-Majority Tract",
       x = "Date", y = "Total Filings",
       color = "Racial Majority") +
  theme_minimal()
```

## Descriptive Distributions

### Distribution of Monthly Findings

```{r create-monthly-predictions-plot-by-tract}
# Create monthly evictions
# Filings_2020 = total eviction filings
ggplot(evictions %>% filter(filings_2020 <= 50),
       aes(filings_2020)) +
  geom_histogram(bins = 30, fill = "steelblue") +
  labs(title = "Distribution of Monthly Filings per Tract (<= 50)",
       x = "Filings", y = "Count")
```

### Distribution of Delta

```{r change-from-baseline-distribution}
# Distribution of Delta 
ggplot(evictions, aes(delta)) +
  geom_histogram(bins = 30, fill = "purple") +
  labs(
    title = "Delta: Filings vs Pre-Pandemic Baseline",
    x = "Delta",
    y = "Count"
  )
```

### Distribution of Ratio

```{r change-from-baseline-distribution-ratio}
# Distribution of Ratio 
ggplot(evictions, aes(ratio)) +
  geom_histogram(bins = 30, fill = "darkgreen") +
  labs(
    title = "Ratio of Filings to Baseline",
    x = "Ratio",
    y = "Count"
  )
```

## Racial Disparaties

```{r mean-filings-by-race}
evictions %>%
  group_by(racial_majority) %>%
  summarise(mean_filings = mean(filings_2020, na.rm = TRUE)) %>%
  ggplot(aes(racial_majority, mean_filings, fill = racial_majority)) +
  geom_col() +
  labs(
    title = "Average Monthly Eviction Filings by Racial-Majority Tract",
    x = "Racial Majority Group",
    y = "Average Monthly Filings"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

# Import Predictor Data

## Affordable Housing Production/Availability

```{r import-affordable-housing}
housing_sf <- st_read('./data/Affordable_Housing.geojson', quiet = T) %>% 
  st_transform(2272)

# filter out properties for which there is no year associated and geometry is not empty
housing <- housing_sf %>% 
  filter(!is.na(fiscal_year_complete),
         !st_is_empty(.)) %>% 
  st_join(tracts, join = st_within)
```

```{r viz-affordable-housing}
ggplot() +
  geom_sf(data = tracts,
          fill = NA,
          color = 'grey70') +
  geom_sf(data = housing, 
          mapping = aes(size = total_units),
          lwd = 0,
          color = 'purple4',
          alpha = 0.25) +
  labs(title = "Affordable Housing in Philadelphia",
       subtitle = "Locations and Total Unit Counts",
       size = 'Total Units') +
  theme_void()
```

Create summary counts of the number of affordable housing units have
been constructed per census tract up to the year. Also create an
indicator variable showing if there was affordable housing built in the
census tract.

```{r message=FALSE}
housing_cnts <- housing %>% 
  st_drop_geometry() %>% 
  group_by(GEOID, fiscal_year_complete) %>% 
  summarise(n_proj = n(),
            total_units = sum(total_units)) %>%
  mutate(n_proj_cum = ave(n_proj, FUN = cumsum),
         total_units_cum = ave(total_units, FUN = cumsum)) %>% 
  filter(fiscal_year_complete >= 2020) %>% 
  left_join(tracts, by = "GEOID") %>% 
  st_as_sf(crs = 2272)
```

```{r}
ggplot() +
  geom_sf(data = tracts, color = 'grey85', fill = NA) +
  geom_sf(data = housing_cnts, aes(fill = total_units_cum)) + 
  facet_wrap(~fiscal_year_complete) +
  theme_void()
```

## Crime

```{r load-crime}
# Path to the main directory that contains the crimeXXXX folders
crime_main_dir <- "./data/crime/"

# 1. Find all subdirectories matching "crimeXXXX"
crime_subdirs <- list.dirs(crime_main_dir, full.names = TRUE, recursive = FALSE)

# 2. Find all .shp files inside those directories
crime_files <- list.files(crime_subdirs, pattern = "\\.shp$", full.names = TRUE)

# 3. Read all shapefiles into a list
crime_list <- lapply(crime_files, function(x) {
  st_read(x, quiet = T) %>% 
    st_transform(2272)
  }) %>% do.call(rbind, .)

crime <- crime %>% filter(!if_any(c('point_x', 'point_y'), is.na))
```

```{r message=FALSE}
# join tract geoid to crimes and filter out those not in Philly
crime_tract <- st_join(crime, tracts, join = st_intersects) %>% 
  filter(!is.na(GEOID))

# create a month/year column
crime_tract <- crime_tract %>% 
  mutate(month = format(dispatch_d, format = "%m/%Y"))

# summarize by the number of each type of crime per census tract per month
crime_cnts <- crime_tract %>% 
  st_drop_geometry() %>% 
  group_by(GEOID, month) %>% 
  summarise(count = n()) %>% 
  ungroup() %>%  
  complete(data = ., GEOID, month, fill = list(count = 0))
```

## Market Value Analysis

```{r}
# read in results of 
mva <- st_read('./data/mva_2023.geojson', quiet = T) %>%
  st_transform(2272)

# the data is at the block group level
# GEOID (12 digits) = tract (11 digits) + block grp (1 digit)
mva <- mva %>% 
  mutate(GEOID_Tract = substr(geoid, 1, nchar(geoid)-1))
```

## Housing Counseling Agencies

```{r}
# create k-nearest neighbors function
get_knn_distance <- function(dist_matrix, k) {
  apply(dist_matrix, 1, function(distances) {
    mean(as.numeric(sort(distances)[1:k]))
  })
}
```

```{r}
# load housing counseling agency locations
hca <- st_read('./data/HousingCounselingAgencies.geojson', quiet = T) %>% 
  st_transform(2272)

# create centroids for each tract to calculate distances
tracts_cent <- tracts %>% 
  st_centroid()

# claculate distance matrix
hca_distmatrix <- st_distance(tracts_cent, hca)

# distance to the nearest 1 and nearest 3 HCAs
hca_dist <- tracts %>% 
  mutate(dist_1hca = get_knn_distance(hca_distmatrix, k = 1),
         dist_3hca = get_knn_distance(hca_distmatrix, k = 3))
```

## Census Demographic Variables

```{r}
years <- c(2020:2023)

vars <- c('pop_tot' = 'B01003_001',   # total tract population
          'pop_white' = 'B02001_002', # white population (for %-non-white calc)
          'units_tot' = 'B25001_001', # total housing units
          'hh_tot' = 'B11001_001',    # total households
          'hh_fam' = 'B11001_002')    # family households)

demo_vars <- map_df(years, function(y) {
  get_acs(
    geography = "tract",
    variables = vars,
    year = y,
    survey = "acs5",
    state = fips_pa,
    county = fips_phl,
    progress_bar = F
  ) %>%
  mutate(year = y)
})

```

```{r combine-vars}

evictions_trim <- evictions %>% filter(my(month) >= '2022-01-01')
```
